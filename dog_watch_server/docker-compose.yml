version: '3.7'
services:
  rabbitmq:
    image: rabbitmq:management
    command: rabbitmq-server
    restart: always
    ports:
     - 15672:15672
    networks:
      - dog_watch_network

  message_coordinator:
    image: message_coordinator
    build:
      context: ./
      dockerfile: Dockerfile_message_coordinator
    networks:
     - dog_watch_network
    restart: always
    depends_on:
     - rabbitmq
    environment:
      - "RABBIT_MQ_HOST=rabbitmq"

  dog_detector:
    image: dog_detector
    build:
      context: ./
      dockerfile: Dockerfile_dog_detector
    networks:
     - dog_watch_network
    restart: always
    devices:
     - "/dev/gpiomem:/dev/gpiomem"
    environment:
      - "MOTION_DETECTOR_CONTROL_PIN=17"
      - "RABBIT_MQ_HOST=rabbitmq"
    depends_on:
     - message_coordinator

  web_server:
    build:
      context: ./
      dockerfile: Dockerfile_web_server
    image: server
    networks:
     - dog_watch_network
    volumes:
     - "/tmp/dog_watch/images/:/app/static"
    restart: always
    environment:
      - "RABBIT_MQ_HOST=rabbitmq"
    ports:
     - 5000:5000
    depends_on:
     - message_coordinator

  camera_service:
    build:
      context: ./
      dockerfile: Dockerfile_camera_service
    image: camera_service
    privileged: true
    group_add:
     - video
    environment:
     - "LD_LIBRARY_PATH: /opt/vc/lib"
     - "RABBIT_MQ_HOST=rabbitmq"
    volumes:
     - /opt/vc:/opt/vc
     - /run/udev:/run/udev:ro
     - "/tmp/dog_watch/images/:/images/"
    devices:
     - "/dev/vchiq:/dev/vchiq"
    networks:
     - dog_watch_network
    restart: always
    depends_on:
     - message_coordinator
networks:
  dog_watch_network:

